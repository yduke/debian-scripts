#!/bin/bash

# ========================
#       ç³»ç»Ÿç»´æŠ¤å·¥å…·
#  System Maintenance Tool
#    for Debian Ubuntu
#       by Duke Yin
# ========================

# é¢œè‰²å®šä¹‰
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
BLUE="\e[1;34m"
CYAN="\e[36m"
RESET="\e[0m"

# æ£€æŸ¥å¹¶å®‰è£…å‘½ä»¤
# ç”¨æ³•: require_command <å‘½ä»¤å> [<åŒ…å>]
# ä¾‹å¦‚æ£€æŸ¥ç¡®ä¿curlå·²å®‰è£…ï¼š
# require_command curl
# å¦‚æœå‘½ä»¤åå’ŒåŒ…åä¸åŒï¼Œç¬¬äºŒä¸ªå‚æ•°å°±å¯ä»¥æŒ‡å®šåŒ…åï¼š
# require_command python3 python3-pip

require_command() {
    local cmd=$1
    local pkg=${2:-$cmd}  # é»˜è®¤åŒ…åå’Œå‘½ä»¤åç›¸åŒ
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo -e "${YELLOW}æœªæ£€æµ‹åˆ° $cmdï¼Œæ­£åœ¨å®‰è£… $pkg...${RESET}"
        # åªåœ¨éœ€è¦å®‰è£…æ—¶å†æ›´æ–° aptï¼Œé¿å…æ¯æ¬¡éƒ½ update
        apt update -y
        apt install -y "$pkg"
    fi
}

# è·å–å½“å‰æœåŠ¡å™¨ IPv4
get_ipv4() {
    # 1. é€šè¿‡é»˜è®¤è·¯ç”±è·å–ï¼ˆæœ€å‡†ç¡®ï¼‰
    local ip
    ip=$(ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K[0-9.]+')
    if [[ -n "$ip" ]]; then
        echo "$ip"
        return
    fi

    # 2. ä½¿ç”¨ hostname -I
    ip=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [[ -n "$ip" ]]; then
        echo "$ip"
        return
    fi

    # 3. å¤–ç½‘æ¢æµ‹ï¼ˆä¸ä¿è¯æˆåŠŸï¼Œæœ€åå…œåº•ï¼‰
    require_command curl
    ip=$(curl -4 -s https://api.ipify.org || true)
    if [[ -n "$ip" ]]; then
        echo "$ip"
        return
    fi

    echo "æ— æ³•è‡ªåŠ¨è·å– IP"
}
SERVER_IP=$(get_ipv4)

get_ipv6() {
    ipv6=$(ip -6 addr show scope global | grep -oP 'inet6 \K[0-9a-f:]+')
    if [ -z "$ipv6" ]; then
        echo "No IPv6 address found"
    else
        echo "$ipv6"
    fi
}
SERVER_IP6=$(get_ipv6)


# ---------- ä¸»èœå• ----------
main_menu() {
    while true; do
        clear
        echo -e "${BLUE}=============================${RESET}"
        echo -e "${BLUE}       ç³»ç»Ÿç»´æŠ¤å·¥å…·${RESET}"
        echo -e "${BLUE}  System Maintenance Tool${RESET}"
        echo -e "${BLUE}       by Duke Yin${RESET}"
        echo -e "${BLUE}=============================${RESET}"
        echo -e "${YELLOW}1)${RESET} æ›´æ–°è½¯ä»¶åŒ… + å‡çº§ + æ¸…ç†"
        echo -e "${YELLOW}2)${RESET} æ›´æ–°å¹¶å‡çº§å†…æ ¸"
        echo -e "${YELLOW}3)${RESET} æ›´æ¢ä¸ºå›½å†…è½¯ä»¶æº"
        echo -e "${YELLOW}4)${RESET} ç³»ç»Ÿç®¡ç†"
        echo -e "${YELLOW}5)${RESET} æ›´æ–° SSL è¯ä¹¦ï¼ˆè¯·å‹¿å°è¯•ï¼‰"
        echo -e "${YELLOW}6)${RESET} Docker å®‰è£…ä¸ç®¡ç†"
        echo -e "${YELLOW}7)${RESET} ç³»ç»Ÿæ£€æŸ¥"
        echo -e "${YELLOW}8)${RESET} æ›´æ–°è„šæœ¬"
        echo -e "${YELLOW}0)${RESET} é€€å‡º"
        echo -e "${BLUE}-----------------------------${RESET}"
        read -p "è¯·è¾“å…¥é€‰é¡¹: " choice

        case "$choice" in
            1) update_system ;;
            2) upgrade_kernel ;;
            3) change_sources ;;
            4) system_menu ;;
            5) update_ssl_certificates ;;
            6) docker_menu ;;
            7) system_check_menu ;;
            8) self_update ;;
            0) echo -e "${GREEN}é€€å‡ºã€‚${RESET}"; exit 0 ;;
            *) echo -e "${RED}æ— æ•ˆé€‰é¡¹${RESET}"; sleep 1 ;;
        esac
    done
}

# ---------- 1 æ›´æ–°è½¯ä»¶åŒ… + å‡çº§ + æ¸…ç† ----------
update_system() {
    echo -e "${GREEN}å¼€å§‹æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨...${RESET}"
    apt update -y
    echo -e "${GREEN}å¼€å§‹å‡çº§è½¯ä»¶åŒ…...${RESET}"
    apt upgrade -y
    echo -e "${GREEN}å¼€å§‹æ¸…ç†ä¸éœ€è¦çš„è½¯ä»¶åŒ…...${RESET}"
    apt autoremove -y
    apt clean
    read -p "å®Œæˆï¼æŒ‰å›è½¦è¿”å›ä¸»èœå•..."
}

# ---------- 2 å‡çº§å†…æ ¸ ----------
upgrade_kernel() {
    echo -e "${GREEN}å¼€å§‹å‡çº§å†…æ ¸åŠç›¸å…³è½¯ä»¶åŒ…...${RESET}"
    apt update -y
    apt full-upgrade -y
    apt autoremove --purge -y
    if [ -f /var/run/reboot-required ]; then
        echo -e "${RED}ç³»ç»Ÿéœ€è¦é‡å¯ï¼${RESET}"
    fi
    read -p "æŒ‰å›è½¦è¿”å›ä¸»èœå•..."
}

# ---------- 3 æ›´æ¢è½¯ä»¶æº ----------
change_sources() {
    echo -e "${GREEN}æ­£åœ¨è·å–æ¢æºè„šæœ¬ ...${RESET}"
    # æ£€æŸ¥ curl
    require_command curl
    bash <(curl -sSL https://linuxmirrors.cn/main.sh)
    read -p "æŒ‰å›è½¦è¿”å›ä¸»èœå•..."
}


# ---------- 4 ç³»ç»Ÿç®¡ç† ----------
system_menu() {
    while true; do
        clear
        echo -e "${BLUE}----- ç³»ç»Ÿç®¡ç† -----${RESET}"
        echo -e "${YELLOW}1)${RESET} å¼€å¯SSHè¿œç¨‹å¯†ç ç™»å½•"
        echo -e "${YELLOW}2)${RESET} å®‰è£…æˆ–æ›´æ–° ddns-go"
        echo -e "${RED}3) å¸è½½ ddns-go${RESET}"
        echo -e "${YELLOW}0)${RESET} è¿”å›ä¸»èœå•"
        read -p "è¯·è¾“å…¥é€‰é¡¹: " choice
        case "$choice" in
            1)
                echo -e "${GREEN}ğŸ”§ å¼€å¯ SSH è¿œç¨‹å¯†ç ç™»å½•...${RESET}"
                # ç¡®ä¿ä»¥ root ç”¨æˆ·è¿è¡Œ
                if [ "$EUID" -ne 0 ]; then
                    echo -e "${YELLOW}è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ï¼${RESET}"
                    echo -e "${YELLOW}æƒé™ä¸è¶³ï¼Œé€€å‡ºï¼${RESET}"
                    exit 1
                fi

                SSHD_CONFIG="/etc/ssh/sshd_config"

                # æ£€æŸ¥ openssh-server æ˜¯å¦å®‰è£…
                if ! dpkg -l | grep -qw openssh-server; then
                    echo -e "${YELLOW}ç³»ç»Ÿæœªå®‰è£… openssh-serverï¼Œæ­£åœ¨å®‰è£…...${RESET}"
                    apt update
                    apt install -y openssh-server
                else
                    echo -e "${GREEN}openssh-server å·²å®‰è£…ã€‚${RESET}"
                fi

                # å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
                BACKUP_FILE="/etc/ssh/sshd_config.bak.$(date +%F-%T)"
                cp "$SSHD_CONFIG" "$BACKUP_FILE"
                echo -e "${GREEN}å·²å¤‡ä»½åŸå§‹é…ç½®åˆ° $BACKUP_FILE${RESET}"

                # ä¿®æ”¹æˆ–æ·»åŠ  PermitRootLogin yes
                if grep -qE "^\s*PermitRootLogin" "$SSHD_CONFIG"; then
                    sed -i "s/^\s*PermitRootLogin.*/PermitRootLogin yes/" "$SSHD_CONFIG"
                else
                    echo "PermitRootLogin yes" >> "$SSHD_CONFIG"
                fi

                # ä¿®æ”¹æˆ–æ·»åŠ  PasswordAuthentication yes
                if grep -qE "^\s*PasswordAuthentication" "$SSHD_CONFIG"; then
                    sed -i "s/^\s*PasswordAuthentication.*/PasswordAuthentication yes/" "$SSHD_CONFIG"
                else
                    echo "PasswordAuthentication yes" >> "$SSHD_CONFIG"
                fi

                # ç¡®ä¿ SSH æœåŠ¡å¯åŠ¨
                systemctl enable ssh

                # é‡å¯ SSH æœåŠ¡
                systemctl restart ssh
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}SSH æœåŠ¡å·²é‡å¯ï¼Œè¿œç¨‹ç™»å½•å·²å¼€å¯ã€‚${RESET}"
                    echo -e "${GREEN}ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ root æˆ–æ™®é€šç”¨æˆ·é€šè¿‡å¯†ç è¿œç¨‹ç™»å½• SSHã€‚${RESET}"
                else
                    echo -e "${RED}SSH æœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š$SSHD_CONFIG${RESET}"
                fi
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            2)
                INSTALL_DIR="/usr/local/ddns-go"
                SERVICE_FILE="/etc/systemd/system/ddns-go.service"

                echo -e "${GREEN}å¼€å§‹æŸ¥è¯¢ ddns-go æœ€æ–°ç‰ˆæœ¬...${RESET}"
                require_command curl

                LATEST_VERSION=$(curl -s https://api.github.com/repos/jeessy2/ddns-go/releases/latest | grep tag_name | cut -d '"' -f 4)

                if [ -z "$LATEST_VERSION" ]; then
                    echo -e "${RED}è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥ï¼Œé€€å‡ºã€‚${RESET}"
                    exit 1
                fi

                echo -e "${GREEN}æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION${RESET}"

                # æ„é€ ä¸‹è½½ URL
                TAR_FILE="ddns-go_${LATEST_VERSION#v}_linux_x86_64.tar.gz"
                DOWNLOAD_URL="https://github.com/jeessy2/ddns-go/releases/download/${LATEST_VERSION}/${TAR_FILE}"

                echo -e "${GREEN}ä¸‹è½½åœ°å€: $DOWNLOAD_URL${RESET}"

                # åˆ¤æ–­æ˜¯å¦å·²ç»å®‰è£…
                if systemctl is-active --quiet ddns-go.service; then
                    MODE="update"
                    echo -e "${GREEN}æ£€æµ‹åˆ° ddns-go æ­£åœ¨è¿è¡Œï¼Œå°†æ‰§è¡Œæ›´æ–°æ“ä½œ...${RESET}"
                else
                    if [ -f "$SERVICE_FILE" ]; then
                        MODE="update"
                        echo -e "${GREEN}æ£€æµ‹åˆ° ddns-go å·²å®‰è£…ä½†æœªè¿è¡Œï¼Œå°†æ‰§è¡Œæ›´æ–°æ“ä½œ...${RESET}"
                    else
                        MODE="install"
                        echo -e "${GREEN}ddns-go æœªå®‰è£…ï¼Œå°†æ‰§è¡Œå…¨æ–°å®‰è£…...${RESET}"
                    fi
                fi

                # åœæ­¢æœåŠ¡ï¼ˆå¦‚å·²å®‰è£…ï¼‰
                if [ "$MODE" = "update" ]; then
                    echo -e "${GREEN}åœæ­¢ ddns-go.service ...${RESET}"
                    systemctl stop ddns-go.service || true
                fi

                echo -e "${GREEN}åˆ›å»ºç›®å½•: $INSTALL_DIR${RESET}"
                mkdir -p "$INSTALL_DIR"
                cd "$INSTALL_DIR"

                echo -e "${GREEN}ä¸‹è½½æœ€æ–°ç‰ˆ ddns-go...${RESET}"
                if [ -f "$TAR_FILE" ]; then
                    echo -e "${GREEN}å‘ç°æœ¬åœ°å·²å­˜åœ¨ $TAR_FILE ï¼Œè·³è¿‡ä¸‹è½½ã€‚${RESET}"
                else
                    echo -e "${GREEN}æ­£åœ¨ä¸‹è½½ $TAR_FILE ...${RESET}"
                    wget -O "$TAR_FILE" "$DOWNLOAD_URL"
                fi

                echo -e "${GREEN}è§£å‹è¦†ç›–...${RESET}"
                tar -zxvf "$TAR_FILE"
                if [ "$MODE" = "update" ]; then
                    echo -e "${GREEN}å¸è½½æ—§çš„ ddns-go systemd æœåŠ¡...${RESET}"
                    "${INSTALL_DIR}/ddns-go" -s uninstall || true
                    echo -e "${GREEN}æ—§æœåŠ¡å¸è½½å®Œæˆã€‚${RESET}"
                fi
                echo -e "${GREEN}å®‰è£…/æ›´æ–° systemd æœåŠ¡...${RESET}"
                "${INSTALL_DIR}/ddns-go" -s install

                echo -e "${GREEN}é‡è½½ systemctl...${RESET}"
                systemctl daemon-reload

                echo -e "${GREEN}å¯åŠ¨ ddns-go.service...${RESET}"
                systemctl start ddns-go.service

                echo -e "${GREEN}è®¾ç½®å¼€æœºè‡ªå¯...${RESET}"
                systemctl enable ddns-go.service

                echo -e "${GREEN}æ¸…ç†å®‰è£…æ–‡ä»¶...${RESET}"
                rm -f "$TAR_FILE"
                rm -f "${INSTALL_DIR}/README_EN.md"
                rm -f "${INSTALL_DIR}/README.md"
                rm -f "${INSTALL_DIR}/LICENSE"

                echo -e "${GREEN}é˜²ç«å¢™æ”¾è¡Œ...${RESET}"
                if command -v ufw >/dev/null 2>&1; then
                    echo -e "${GREEN}æ£€æµ‹åˆ° UFWï¼Œæ”¾è¡Œç«¯å£ 9876...${RESET}"
                    ufw allow 9876/tcp || true
                fi

                echo -e "${GREEN}ddns-go $MODE å®Œæˆï¼å½“å‰ç‰ˆæœ¬ï¼š$LATEST_VERSION${RESET}"
   
                if [[ "$SERVER_IP" = "æ— æ³•è‡ªåŠ¨è·å– IP" ]]; then
                    echo -e "${YELLOW}Web ç•Œé¢è®¿é—®: http://ä½ çš„IP:9876${RESET}"
                else
                    echo -e "${GREEN}Web ç•Œé¢è®¿é—®: http://$SERVER_IP:9876${RESET}"
                fi

                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            3)
                echo -e "${RED}å¸è½½ ddns-go${RESET}"
                INSTALL_DIR="/usr/local/ddns-go"
                SERVICE_FILE="/etc/systemd/system/ddns-go.service"
                # åˆ¤æ–­æ˜¯å¦å·²ç»å®‰è£…
                if systemctl is-active --quiet ddns-go.service; then
                    MODE="uninstall"
                    echo -e "${GREEN}æ£€æµ‹åˆ° ddns-go æ­£åœ¨è¿è¡Œï¼Œå°†æ‰§è¡Œå¸è½½...${RESET}"
                else
                    if [ -f "$SERVICE_FILE" ]; then
                        MODE="uninstall"
                        echo -e "${GREEN}æ£€æµ‹åˆ° ddns-go å·²å®‰è£…ä½†æœªè¿è¡Œï¼Œå°†æ‰§è¡Œå¸è½½æ“ä½œ...${RESET}"
                    else
                        echo -e "${GREEN}ddns-go æœªå®‰è£…ï¼Œæ— éœ€å¸è½½${RESET}"
                        exit 1
                    fi
                fi
                # åœæ­¢æœåŠ¡
                echo -e "${GREEN}åœæ­¢ ddns-go.service ...${RESET}"
                systemctl stop ddns-go.service || true
                echo -e "${GREEN}å¸è½½ ddns-go systemd æœåŠ¡...${RESET}"
                "${INSTALL_DIR}/ddns-go" -s uninstall || true
                echo -e "${GREEN}æœåŠ¡å¸è½½å®Œæˆã€‚${RESET}"
                echo -e "${GREEN}åˆ é™¤å®‰è£…ç›®å½•...${RESET}"
                rm -rf "$INSTALL_DIR"
                echo -e "${GREEN}ddns-go å¸è½½å®Œæˆï¼${RESET}"
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            0) break ;;
            *) echo -e "${RED}æ— æ•ˆé€‰é¡¹${RESET}"; sleep 1 ;;
        esac
    done
}


# ---------- 5 æ›´æ–° SSL è¯ä¹¦ ----------
update_ssl_certificates() {
    echo -e "${GREEN}ğŸ”„ æ­£åœ¨æ›´æ–° SSL è¯ä¹¦ ...${RESET}"
    if command -v pve-cert-sync &> /dev/null; then
        pve-cert-sync
    else
        echo -e "${YELLOW}å‘½ä»¤ pve-cert-sync ä¸å­˜åœ¨ï¼Œæ‰§è¡Œæ›¿ä»£æ“ä½œ${RESET}"
        # æ£€æŸ¥ curl
        require_command curl
        bash <(curl -fsSL https://raw.githubusercontent.com/yduke/pve-cert-sync/main/install.sh)
        pve-cert-sync
    fi
    read -p "å®Œæˆï¼æŒ‰å›è½¦è¿”å›ä¸»èœå•..."
}

# ---------- Docker èœå• ----------
docker_menu() {
    while true; do
        clear
        echo -e "${BLUE}----- Docker ç®¡ç† -----${RESET}"
        echo -e "${YELLOW}1)${RESET} å®‰è£… Docker"
        echo -e "${YELLOW}2)${RESET} æ›´æ¢ Docker é•œåƒåŠ é€Ÿæº"
        echo -e "${YELLOW}0)${RESET} è¿”å›ä¸»èœå•"
        read -p "è¯·è¾“å…¥é€‰é¡¹: " choice
        case "$choice" in
            1)
                echo -e "${GREEN}å®‰è£… Docker ...${RESET}"
                # æ£€æŸ¥ curl
                require_command curl
                bash <(curl -sSL https://linuxmirrors.cn/docker.sh)
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            2)
                echo -e "${GREEN}æ›´æ¢ Docker é•œåƒåŠ é€Ÿæº ...${RESET}"
                # æ£€æŸ¥ curl
                require_command curl
                bash <(curl -sSL https://linuxmirrors.cn/docker.sh) --only-registry
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            0) break ;;
            *) echo -e "${RED}æ— æ•ˆé€‰é¡¹${RESET}"; sleep 1 ;;
        esac
    done
}

# ---------- 7 ç³»ç»Ÿæ£€æŸ¥ ----------
system_check_menu() {
    while true; do
        clear
        echo -e "${BLUE}----- ç³»ç»Ÿæ£€æŸ¥ -----${RESET}"
        echo -e "${YELLOW}1)${RESET} æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯"
        echo -e "${YELLOW}2)${RESET} æŸ¥çœ‹ç£ç›˜ç©ºé—´"
        echo -e "${YELLOW}3)${RESET} æŸ¥çœ‹æœ€è¿‘ç³»ç»Ÿæ—¥å¿—"
        echo -e "${YELLOW}4)${RESET} æŸ¥çœ‹ CPU ä½¿ç”¨"
        echo -e "${YELLOW}5)${RESET} æŸ¥çœ‹å†…å­˜ä½¿ç”¨"
        echo -e "${YELLOW}6)${RESET} æŸ¥çœ‹ç³»ç»Ÿé…ç½®"
        echo -e "${YELLOW}7)${RESET} æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬"
        echo -e "${YELLOW}8)${RESET} æŸ¥çœ‹å¤±è´¥æœåŠ¡"
        echo -e "${YELLOW}9)${RESET} æŸ¥çœ‹IPåœ°å€"
        echo -e "${YELLOW}0)${RESET} è¿”å›ä¸»èœå•"
        read -p "è¯·è¾“å…¥é€‰é¡¹: " choice
        case "$choice" in
            1)
                if [ -f /var/run/reboot-required ]; then
                    echo -e "${RED}ç³»ç»Ÿéœ€è¦é‡å¯ï¼${RESET}"
                    cat /var/run/reboot-required
                else
                    echo -e "${GREEN}ä¸éœ€è¦é‡å¯ã€‚${RESET}"
                fi
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            2)
                echo -e "${CYAN}ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µï¼š${RESET}"
			    hd_percent=$(df --output=pcent / | tail -1 | tr -dc '0-9.')
			    hd_used=$(df --output=used / | tail -1)
			    hd_used_gb=$(awk -v k="$hd_used" 'BEGIN {printf "%.2f", k/1024/1024}')
			    echo "å·²ä½¿ç”¨ $hd_percent %ï¼Œä½¿ç”¨äº† $hd_used_gb GB"
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            3)
                echo -e "${CYAN}æœ€è¿‘ 50 è¡Œç³»ç»Ÿæ—¥å¿—ï¼š${RESET}"
                journalctl -n 50
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            4)
                echo -e "${CYAN}CPU ä½¿ç”¨æƒ…å†µï¼š${RESET}"
                top -b -n 1 | head -n 5
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            5)
                echo -e "${CYAN}å†…å­˜ä½¿ç”¨æƒ…å†µï¼š${RESET}"

                get_mem_info() {
                    awk '
                        /MemTotal:/      {total=$2}
                        /MemAvailable:/  {avail=$2}
                        END {
                            used = total - avail
                            printf("%.1f %.2f", used/total*100, used/1024/1024)
                        }
                    ' /proc/meminfo
                }
                read mem_percent mem_used_gb <<< "$(get_mem_info)"
                echo "å·²ä½¿ç”¨ $mem_percent %ï¼Œä½¿ç”¨äº† $mem_used_gb GB"
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            6)
                echo -e "${CYAN}å½“å‰ç³»ç»Ÿé…ç½®ï¼š${RESET}"
                hostnamectl
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            7)
                echo -e "${CYAN}å½“å‰å†…æ ¸ç‰ˆæœ¬ï¼š${RESET}"
                uname -r
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            8)
                echo -e "${CYAN}æŸ¥çœ‹å¤±è´¥æœåŠ¡ï¼š${RESET}"
                failed=$(systemctl --failed --no-pager --plain --quiet | awk 'NR>1 {print $1}')
                if [ -z "$failed" ]; then
                    echo -e "${GREEN}å½“å‰æ²¡æœ‰å¤±è´¥æœåŠ¡${RESET}"
                else
                    for svc in $failed; do
                        echo -e "\næœåŠ¡: $svc"
                        journalctl -u "$svc" -n 20 --no-pager
                    done
                fi
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            9)
                echo -e "${CYAN}å½“å‰ IP åœ°å€ï¼š${RESET}"
                echo -e "IPV4: ${GREEN}$SERVER_IP${RESET}"
                echo -e "IPV6: ${GREEN}$SERVER_IP6${RESET}"
                read -p "æŒ‰å›è½¦è¿”å›..."
                ;;
            0) break ;;
            *) echo -e "${RED}æ— æ•ˆé€‰é¡¹${RESET}"; sleep 1 ;;
        esac
    done
}

# ---------- æ›´æ–° ----------
self_update(){
    echo -e "${GREEN}æ­£åœ¨æ›´æ–°è„šæœ¬...${RESET}"
    require_command curl
    bash <(curl -fsSL https://raw.githubusercontent.com/yduke/debian-scripts/main/install.sh)
    echo -e "${GREEN}è„šæœ¬å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼${RESET}"
    echo -e "${GREEN}éœ€è¦é‡å¯è„šæœ¬ç”Ÿæ•ˆã€‚${RESET}"
    read -p "æŒ‰å›è½¦é€€å‡ºè„šæœ¬ï¼Œä½ éœ€è¦å†æ¬¡æ‰§è¡Œupdateä½¿ç”¨æ–°ç‰ˆã€‚"
    exit 0
}

# ---------- å¯åŠ¨ä¸»èœå• ----------
main_menu
